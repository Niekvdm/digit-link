# TCP Tunnel Service Configuration
#
# This configuration enables the TCP+TLS tunnel listener (yamux-based multiplexing)
# for multi-forward client connections. Uses HAProxy TCP Custom Resource for
# TCP passthrough on port 4443.
#
---
# ClusterIP Service for the tunnel endpoint
apiVersion: v1
kind: Service
metadata:
  name: digit-link-tunnel
  namespace: dzone-dev
  labels:
    app: digit-link
    component: tunnel
spec:
  selector:
    app: digit-link
  ports:
  - name: tcp-tunnel
    protocol: TCP
    port: 4443
    targetPort: 4443
  type: ClusterIP
---
# HAProxy Backend CR with PROXY v2 protocol to preserve client IPs
apiVersion: ingress.v1.haproxy.org/v1
kind: Backend
metadata:
  name: digit-link-tunnel-backend
  namespace: dzone-dev
  annotations:
    ingress.class: haproxy
spec:
  config:
    # MUST match the backend name created by the TCP CR
    # You already confirmed this name in HAProxy logs
    name: dzone-dev_svc_digit-link-tunnel_tcp-tunnel

    # Enable PROXY protocol v2 towards backend servers
    # Apply server-* options to all servers in this backend
    default_server:
      send-proxy-v2: enabled
---
# HAProxy TCP Custom Resource for external TCP passthrough
apiVersion: ingress.v1.haproxy.org/v1
kind: TCP
metadata:
  name: digit-link-tunnel
  namespace: dzone-dev
  annotations:
    ingress.class: haproxy
spec:
- name: digit-link-tunnel
  frontend:
    name: fe-digit-link-tunnel-4443
    tcplog: true
    mode: tcp
    default_backend: digit-link-tunnel-backend
    binds:
    - name: tunnel-bind
      port: 4443
  service:
    name: digit-link-tunnel
    port: 4443

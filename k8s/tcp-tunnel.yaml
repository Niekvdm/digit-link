# TCP Tunnel Service Configuration
#
# This configuration enables the TCP+TLS tunnel listener (yamux-based multiplexing)
# for multi-forward client connections. The tunnel port (4443) must be exposed via
# TCP passthrough, NOT HTTP/HTTPS ingress.
#
# IMPORTANT: HAProxy Ingress Controller TCP Services Setup
#
# HAProxy Ingress requires TCP services to be configured separately from HTTP ingress.
# The tunnel port needs TCP passthrough (not HTTP termination) to preserve TLS.
#
# Option 1: ConfigMap-based TCP services (Recommended)
# =====================================================
# Create a ConfigMap in the HAProxy namespace to define TCP services:
#
#   kubectl -n haproxy-ingress create configmap haproxy-tcp-services \
#     --from-literal=4443="dzone-dev/digit-link-tunnel:4443"
#
# Then patch the HAProxy deployment to use this ConfigMap:
#
#   kubectl -n haproxy-ingress patch deployment haproxy-kubernetes-ingress \
#     --type=json -p='[{"op":"add","path":"/spec/template/spec/containers/0/args/-","value":"--tcp-services-configmap=haproxy-ingress/haproxy-tcp-services"}]'
#
# And expose port 4443 on the HAProxy service:
#
#   kubectl -n haproxy-ingress patch svc haproxy-kubernetes-ingress \
#     --type=json -p='[{"op":"add","path":"/spec/ports/-","value":{"name":"tcp-tunnel","port":4443,"targetPort":4443,"protocol":"TCP"}}]'
#
#
# Option 2: Separate LoadBalancer Service
# =======================================
# If your ingress controller doesn't support TCP services, you can expose the
# tunnel port via a dedicated LoadBalancer service (see tcp-tunnel-lb.yaml below).
#
#
# DNS Configuration
# =================
# Ensure tunnel.link.digit.zone (or your tunnel domain) resolves to:
# - The HAProxy ingress IP if using Option 1
# - The LoadBalancer IP if using Option 2
#
# If using the same domain as HTTP traffic, clients should connect to port 4443.
#
---
# TCP Tunnel ClusterIP Service
apiVersion: v1
kind: Service
metadata:
  name: digit-link-tunnel
  namespace: dzone-dev
  labels:
    app: digit-link
    component: tunnel
spec:
  selector:
    app: digit-link
  ports:
    - name: tcp-tunnel
      protocol: TCP
      port: 4443
      targetPort: 4443
  type: ClusterIP
---
# Optional: Direct LoadBalancer for TCP tunnel (use if ingress doesn't support TCP)
# Uncomment this if you need a dedicated LoadBalancer for tunnel connections
#
# apiVersion: v1
# kind: Service
# metadata:
#   name: digit-link-tunnel-lb
#   namespace: dzone-dev
#   labels:
#     app: digit-link
#     component: tunnel
#   annotations:
#     # Preserve client IP for connection logging
#     # This is important for security/audit purposes
#     service.beta.kubernetes.io/aws-load-balancer-proxy-protocol: "*"
# spec:
#   selector:
#     app: digit-link
#   ports:
#     - name: tcp-tunnel
#       protocol: TCP
#       port: 4443
#       targetPort: 4443
#   type: LoadBalancer
#   # Preserve client source IP (important for TCP tunnels)
#   externalTrafficPolicy: Local
